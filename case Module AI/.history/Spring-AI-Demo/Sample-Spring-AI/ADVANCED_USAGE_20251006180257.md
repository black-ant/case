# ChatClient é«˜çº§é…ç½®æŒ‡å—

è¿™ä¸ªæ–‡æ¡£è¯¦ç»†ä»‹ç»äº† Spring AI ChatClient çš„å„ç§é«˜çº§é…ç½®å’Œç”¨æ³•ã€‚

## ğŸ“š ç›®å½•

1. [åŸºç¡€é…ç½®](#1-åŸºç¡€é…ç½®)
2. [ç³»ç»Ÿæç¤ºè¯](#2-ç³»ç»Ÿæç¤ºè¯)
3. [æ¨¡æ¿å’Œå˜é‡](#3-æ¨¡æ¿å’Œå˜é‡)
4. [é«˜çº§é€‰é¡¹](#4-é«˜çº§é€‰é¡¹)
5. [æµå¼å“åº”](#5-æµå¼å“åº”)
6. [Prompt å¯¹è±¡](#6-prompt-å¯¹è±¡)
7. [å®Œæ•´å“åº”ä¿¡æ¯](#7-å®Œæ•´å“åº”ä¿¡æ¯)
8. [æ¨¡å‹é€‰æ‹©](#8-æ¨¡å‹é€‰æ‹©)
9. [åˆ›é€ æ€§å†™ä½œ](#9-åˆ›é€ æ€§å†™ä½œ)
10. [ç²¾ç¡®å›ç­”](#10-ç²¾ç¡®å›ç­”)

---

## 1. åŸºç¡€é…ç½®

### Temperature å’Œ Max Tokens

```java
chatClient.prompt()
    .user(message)
    .options(OpenAiChatOptions.builder()
        .withTemperature(0.3)  // 0.0-2.0ï¼Œè¶Šä½è¶Šç¡®å®š
        .withMaxTokens(500)    // é™åˆ¶è¾“å‡ºé•¿åº¦
        .build())
    .call()
    .content();
```

**æµ‹è¯•æ¥å£**ï¼š
```bash
curl -X POST http://localhost:8080/api/advanced/basic-options \
  -H "Content-Type: text/plain" \
  -d "ä»€ä¹ˆæ˜¯ Spring AIï¼Ÿ"
```

**å‚æ•°è¯´æ˜**ï¼š
- `temperature`: æ§åˆ¶è¾“å‡ºçš„éšæœºæ€§
  - `0.0-0.3`: ç¡®å®šæ€§è¾“å‡ºï¼Œé€‚åˆäº‹å®æ€§é—®ç­”
  - `0.7-0.9`: å¹³è¡¡åˆ›é€ æ€§å’Œå‡†ç¡®æ€§
  - `1.0-2.0`: é«˜åº¦åˆ›é€ æ€§ï¼Œé€‚åˆåˆ›æ„å†™ä½œ
- `maxTokens`: é™åˆ¶ç”Ÿæˆçš„æœ€å¤§ token æ•°é‡

---

## 2. ç³»ç»Ÿæç¤ºè¯

### è‡ªå®šä¹‰ç³»ç»Ÿè§’è‰²

```java
chatClient.prompt()
    .system("ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ Java å¼€å‘ä¸“å®¶")
    .user(message)
    .call()
    .content();
```

**æµ‹è¯•æ¥å£**ï¼š
```bash
curl -X POST http://localhost:8080/api/advanced/system-prompt \
  -H "Content-Type: application/json" \
  -d '{
    "systemPrompt": "ä½ æ˜¯ä¸€ä¸ªå¹½é»˜é£è¶£çš„ç¼–ç¨‹å¯¼å¸ˆ",
    "message": "è§£é‡Šä¸€ä¸‹ä»€ä¹ˆæ˜¯é€’å½’"
  }'
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- å®šä¹‰ AI çš„è§’è‰²å’Œä¸“ä¸šé¢†åŸŸ
- è®¾ç½®å›ç­”çš„é£æ ¼å’Œè¯­æ°”
- æ·»åŠ ç‰¹å®šçš„çº¦æŸå’Œè§„åˆ™

---

## 3. æ¨¡æ¿å’Œå˜é‡

### ä½¿ç”¨å ä½ç¬¦

```java
chatClient.prompt()
    .system("ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„åŠ©æ‰‹ï¼Œæ­£åœ¨ä¸ {userName} å¯¹è¯ã€‚")
    .user("è¯·è¯¦ç»†ä»‹ç»ä¸€ä¸‹ {topic}")
    .param("userName", "å¼ ä¸‰")
    .param("topic", "Spring Boot")
    .call()
    .content();
```

**æµ‹è¯•æ¥å£**ï¼š
```bash
curl -X POST http://localhost:8080/api/advanced/template \
  -H "Content-Type: application/json" \
  -d '{
    "userName": "ææ˜",
    "topic": "å¾®æœåŠ¡æ¶æ„"
  }'
```

**ä¼˜åŠ¿**ï¼š
- ä»£ç æ›´æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
- å¯ä»¥å¤ç”¨æç¤ºè¯æ¨¡æ¿
- é¿å…å­—ç¬¦ä¸²æ‹¼æ¥é”™è¯¯

---

## 4. é«˜çº§é€‰é¡¹

### Top Pã€Frequency Penaltyã€Presence Penalty

```java
chatClient.prompt()
    .user(message)
    .options(OpenAiChatOptions.builder()
        .withTemperature(0.8)
        .withTopP(0.9)                    // æ ¸é‡‡æ ·
        .withFrequencyPenalty(0.5)        // é™ä½é‡å¤è¯é¢‘ç‡
        .withPresencePenalty(0.5)         // é¼“åŠ±è°ˆè®ºæ–°è¯é¢˜
        .withMaxTokens(2000)
        .build())
    .call()
    .content();
```

**æµ‹è¯•æ¥å£**ï¼š
```bash
curl -X POST http://localhost:8080/api/advanced/advanced-options \
  -H "Content-Type: text/plain" \
  -d "å†™ä¸€ç¯‡å…³äºäººå·¥æ™ºèƒ½çš„æ–‡ç« "
```

**å‚æ•°è¯¦è§£**ï¼š

| å‚æ•° | èŒƒå›´ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|------|------|------|----------|
| `topP` | 0.0-1.0 | æ ¸é‡‡æ ·ï¼Œåªè€ƒè™‘æ¦‚ç‡ç´¯ç§¯åˆ° P çš„ token | æ§åˆ¶è¾“å‡ºå¤šæ ·æ€§ |
| `frequencyPenalty` | -2.0-2.0 | æ ¹æ®è¯é¢‘é™ä½é‡å¤ | é¿å…é‡å¤ä½¿ç”¨ç›¸åŒè¯æ±‡ |
| `presencePenalty` | -2.0-2.0 | æ ¹æ®æ˜¯å¦å‡ºç°è¿‡é™ä½é‡å¤ | é¼“åŠ±è®¨è®ºæ–°è¯é¢˜ |

**ç»„åˆå»ºè®®**ï¼š
- **åˆ›æ„å†™ä½œ**: `temperature=1.0, topP=1.0, presencePenalty=0.6`
- **æŠ€æœ¯æ–‡æ¡£**: `temperature=0.3, topP=0.5, frequencyPenalty=0.3`
- **å¯¹è¯èŠå¤©**: `temperature=0.7, topP=0.9, presencePenalty=0.3`

---

## 5. æµå¼å“åº”

### é…ç½®æµå¼è¾“å‡º

```java
chatClient.prompt()
    .system("ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æŠ€æœ¯å†™ä½œåŠ©æ‰‹ã€‚")
    .user(message)
    .options(OpenAiChatOptions.builder()
        .withTemperature(0.7)
        .withMaxTokens(1500)
        .build())
    .stream()
    .content();
```

**æµ‹è¯•æ¥å£**ï¼š
```bash
curl -N -X POST http://localhost:8080/api/advanced/stream-options \
  -H "Content-Type: text/plain" \
  -d "è¯·è¯¦ç»†ä»‹ç» Spring AI çš„æ ¸å¿ƒåŠŸèƒ½"
```

**æ³¨æ„äº‹é¡¹**ï¼š
- ä½¿ç”¨ `-N` å‚æ•°ç¦ç”¨ curl ç¼“å†²
- è¿”å›ç±»å‹æ˜¯ `Flux<String>`
- é€‚åˆé•¿æ–‡æœ¬ç”Ÿæˆåœºæ™¯

---

## 6. Prompt å¯¹è±¡

### åº•å±‚æ§åˆ¶

```java
Prompt prompt = new Prompt(
    List.of(
        new SystemMessage("ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šåŠ©æ‰‹"),
        new UserMessage("ç”¨æˆ·é—®é¢˜")
    ),
    OpenAiChatOptions.builder()
        .withModel("gpt-3.5-turbo")
        .withTemperature(0.7)
        .withMaxTokens(1000)
        .build()
);

chatClient.prompt(prompt).call().content();
```

**æµ‹è¯•æ¥å£**ï¼š
```bash
curl -X POST http://localhost:8080/api/advanced/prompt-object \
  -H "Content-Type: application/json" \
  -d '{
    "systemPrompt": "ä½ æ˜¯ä¸€ä¸ª Python ä¸“å®¶",
    "message": "è§£é‡Šè£…é¥°å™¨çš„åŸç†"
  }'
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- éœ€è¦å®Œå…¨æ§åˆ¶æ¶ˆæ¯åˆ—è¡¨
- å®ç°å¤æ‚çš„å¤šè½®å¯¹è¯
- æ·»åŠ è‡ªå®šä¹‰æ¶ˆæ¯ç±»å‹

---

## 7. å®Œæ•´å“åº”ä¿¡æ¯

### è·å– Token ä½¿ç”¨æƒ…å†µ

```java
var response = chatClient.prompt()
    .user(message)
    .call()
    .chatResponse();

Map.of(
    "content", response.getResult().getOutput().getContent(),
    "model", response.getMetadata().getModel(),
    "promptTokens", response.getMetadata().getUsage().getPromptTokens(),
    "completionTokens", response.getMetadata().getUsage().getGenerationTokens(),
    "totalTokens", response.getMetadata().getUsage().getTotalTokens()
);
```

**æµ‹è¯•æ¥å£**ï¼š
```bash
curl -X POST http://localhost:8080/api/advanced/full-response \
  -H "Content-Type: text/plain" \
  -d "ä»€ä¹ˆæ˜¯ Spring Bootï¼Ÿ"
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "content": "Spring Boot æ˜¯...",
  "model": "gpt-3.5-turbo-0125",
  "finishReason": "STOP",
  "promptTokens": 15,
  "completionTokens": 120,
  "totalTokens": 135
}
```

**ç”¨é€”**ï¼š
- æˆæœ¬ç›‘æ§å’Œä¼˜åŒ–
- æ€§èƒ½åˆ†æ
- è°ƒè¯•å’Œæ—¥å¿—è®°å½•

---

## 8. æ¨¡å‹é€‰æ‹©

### ä½¿ç”¨ä¸åŒçš„ GPT æ¨¡å‹

```java
chatClient.prompt()
    .user(message)
    .options(OpenAiChatOptions.builder()
        .withModel("gpt-4")  // æˆ– gpt-3.5-turbo, gpt-4-turbo
        .withTemperature(0.7)
        .build())
    .call()
    .content();
```

**æµ‹è¯•æ¥å£**ï¼š
```bash
curl -X POST http://localhost:8080/api/advanced/specific-model \
  -H "Content-Type: application/json" \
  -d '{
    "message": "è§£é‡Šé‡å­è®¡ç®—çš„åŸç†",
    "model": "gpt-4"
  }'
```

**æ¨¡å‹å¯¹æ¯”**ï¼š

| æ¨¡å‹ | é€Ÿåº¦ | æˆæœ¬ | èƒ½åŠ› | é€‚ç”¨åœºæ™¯ |
|------|------|------|------|----------|
| gpt-3.5-turbo | âš¡âš¡âš¡ | ğŸ’° | â­â­â­ | æ—¥å¸¸å¯¹è¯ã€ç®€å•ä»»åŠ¡ |
| gpt-4 | âš¡ | ğŸ’°ğŸ’°ğŸ’° | â­â­â­â­â­ | å¤æ‚æ¨ç†ã€ä¸“ä¸šä»»åŠ¡ |
| gpt-4-turbo | âš¡âš¡ | ğŸ’°ğŸ’° | â­â­â­â­â­ | å¹³è¡¡æ€§èƒ½å’Œæˆæœ¬ |

---

## 9. åˆ›é€ æ€§å†™ä½œ

### é«˜åˆ›é€ æ€§é…ç½®

```java
chatClient.prompt()
    .system("ä½ æ˜¯ä¸€ä¸ªå¯Œæœ‰åˆ›é€ åŠ›çš„ä½œå®¶")
    .user("è¯·å†™ä¸€ä¸ªå…³äº {topic} çš„çŸ­æ•…äº‹")
    .param("topic", topic)
    .options(OpenAiChatOptions.builder()
        .withTemperature(1.0)      // æœ€å¤§åˆ›é€ æ€§
        .withTopP(1.0)
        .withPresencePenalty(0.6)  // é¼“åŠ±æ–°è¯é¢˜
        .withFrequencyPenalty(0.6) // é¿å…é‡å¤
        .withMaxTokens(2000)
        .build())
    .call()
    .content();
```

**æµ‹è¯•æ¥å£**ï¼š
```bash
curl -X POST http://localhost:8080/api/advanced/creative-writing \
  -H "Content-Type: application/json" \
  -d '{
    "topic": "æœªæ¥ä¸–ç•Œçš„ç¨‹åºå‘˜"
  }'
```

**é…ç½®è¦ç‚¹**ï¼š
- é«˜ `temperature` (0.9-1.0)
- é«˜ `presencePenalty` (0.5-0.8)
- é«˜ `frequencyPenalty` (0.5-0.8)
- è¾ƒå¤§çš„ `maxTokens`

---

## 10. ç²¾ç¡®å›ç­”

### ä½éšæœºæ€§é…ç½®

```java
chatClient.prompt()
    .system("ä½ æ˜¯ä¸€ä¸ªä¸¥è°¨çš„æŠ€æœ¯ä¸“å®¶ï¼Œåªæä¾›å‡†ç¡®çš„äº‹å®æ€§ç­”æ¡ˆã€‚")
    .user(question)
    .options(OpenAiChatOptions.builder()
        .withTemperature(0.1)      // æœ€å°éšæœºæ€§
        .withTopP(0.1)
        .withMaxTokens(500)
        .build())
    .call()
    .content();
```

**æµ‹è¯•æ¥å£**ï¼š
```bash
curl -X POST http://localhost:8080/api/advanced/precise-answer \
  -H "Content-Type: text/plain" \
  -d "Java ä¸­ HashMap çš„æ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘ï¼Ÿ"
```

**é…ç½®è¦ç‚¹**ï¼š
- ä½ `temperature` (0.0-0.2)
- ä½ `topP` (0.1-0.3)
- æ˜ç¡®çš„ç³»ç»Ÿæç¤ºè¯
- é€‚ä¸­çš„ `maxTokens`

---

## ğŸ¯ é…ç½®é€ŸæŸ¥è¡¨

### å¸¸è§åœºæ™¯é…ç½®

| åœºæ™¯ | Temperature | Top P | Frequency Penalty | Presence Penalty | Max Tokens |
|------|-------------|-------|-------------------|------------------|------------|
| **äº‹å®é—®ç­”** | 0.1-0.3 | 0.1-0.3 | 0.0 | 0.0 | 500-1000 |
| **ä»£ç ç”Ÿæˆ** | 0.2-0.4 | 0.5 | 0.0 | 0.0 | 1000-2000 |
| **æŠ€æœ¯æ–‡æ¡£** | 0.3-0.5 | 0.5-0.7 | 0.3 | 0.2 | 1500-3000 |
| **æ—¥å¸¸å¯¹è¯** | 0.7-0.9 | 0.9 | 0.3 | 0.3 | 500-1500 |
| **åˆ›æ„å†™ä½œ** | 0.9-1.0 | 1.0 | 0.6 | 0.6 | 2000-4000 |
| **å¤´è„‘é£æš´** | 0.8-1.0 | 0.95 | 0.5 | 0.7 | 1000-2000 |

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä»é»˜è®¤é…ç½®å¼€å§‹
```java
// å…ˆä½¿ç”¨é»˜è®¤é…ç½®æµ‹è¯•
chatClient.prompt()
    .user(message)
    .call()
    .content();
```

### 2. é€æ­¥è°ƒæ•´å‚æ•°
```java
// æ ¹æ®éœ€æ±‚é€æ­¥è°ƒæ•´
chatClient.prompt()
    .user(message)
    .options(OpenAiChatOptions.builder()
        .withTemperature(0.7)  // å…ˆè°ƒæ•´ temperature
        .build())
    .call()
    .content();
```

### 3. ä½¿ç”¨ Builder æ¨¡å¼åˆ›å»ºå¯å¤ç”¨é…ç½®
```java
@Configuration
public class ChatClientConfig {
    
    @Bean
    public ChatClient creativeChatClient(ChatClient.Builder builder) {
        return builder
            .defaultSystem("ä½ æ˜¯ä¸€ä¸ªåˆ›æ„å†™ä½œåŠ©æ‰‹")
            .defaultOptions(OpenAiChatOptions.builder()
                .withTemperature(1.0)
                .withPresencePenalty(0.6)
                .build())
            .build();
    }
    
    @Bean
    public ChatClient preciseChatClient(ChatClient.Builder builder) {
        return builder
            .defaultSystem("ä½ æ˜¯ä¸€ä¸ªä¸¥è°¨çš„æŠ€æœ¯ä¸“å®¶")
            .defaultOptions(OpenAiChatOptions.builder()
                .withTemperature(0.1)
                .withMaxTokens(500)
                .build())
            .build();
    }
}
```

### 4. ç›‘æ§ Token ä½¿ç”¨
```java
var response = chatClient.prompt()
    .user(message)
    .call()
    .chatResponse();

log.info("Token usage - Prompt: {}, Completion: {}, Total: {}",
    response.getMetadata().getUsage().getPromptTokens(),
    response.getMetadata().getUsage().getGenerationTokens(),
    response.getMetadata().getUsage().getTotalTokens()
);
```

---

## ğŸ”— å‚è€ƒèµ„æ–™

- [Spring AI å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-ai/reference/)
- [OpenAI API å‚æ•°è¯´æ˜](https://platform.openai.com/docs/api-reference/chat/create)
- [ChatClient API æ–‡æ¡£](https://docs.spring.io/spring-ai/reference/api/chatclient.html)

---

## ğŸ“ æ€»ç»“

ChatClient æä¾›äº†ä¸°å¯Œçš„é…ç½®é€‰é¡¹ï¼Œå¯ä»¥æ»¡è¶³å„ç§åœºæ™¯çš„éœ€æ±‚ï¼š

1. **åŸºç¡€é…ç½®**ï¼štemperatureã€maxTokens æ§åˆ¶è¾“å‡ºç‰¹æ€§
2. **é«˜çº§é…ç½®**ï¼štopPã€penalties ç²¾ç»†è°ƒæ•´ç”Ÿæˆç­–ç•¥
3. **æç¤ºè¯å·¥ç¨‹**ï¼šsystemã€userã€template æ„å»ºæœ‰æ•ˆæç¤º
4. **å“åº”æ§åˆ¶**ï¼šæµå¼/éæµå¼ã€å®Œæ•´ä¿¡æ¯è·å–
5. **æ¨¡å‹é€‰æ‹©**ï¼šæ ¹æ®ä»»åŠ¡å¤æ‚åº¦é€‰æ‹©åˆé€‚æ¨¡å‹

å…³é”®æ˜¯ç†è§£æ¯ä¸ªå‚æ•°çš„ä½œç”¨ï¼Œå¹¶æ ¹æ®å…·ä½“åœºæ™¯è¿›è¡Œè°ƒæ•´å’Œä¼˜åŒ–ã€‚
