# Streaming Demo - WebFlux æµå¼å“åº”ç¤ºä¾‹

è¿™ä¸ªé¡¹ç›®å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Spring WebFlux å’Œ Spring AI å®ç°å„ç§æµå¼å“åº”æ¨¡å¼ã€‚

## ğŸ¯ ä»€ä¹ˆæ˜¯æµå¼å“åº”ï¼Ÿ

æµå¼å“åº”ï¼ˆStreaming Responseï¼‰æ˜¯ä¸€ç§å®æ—¶æ•°æ®ä¼ è¾“æ–¹å¼ï¼š

- **ä¼ ç»Ÿå“åº”**ï¼šç­‰å¾…å®Œæ•´å†…å®¹ç”Ÿæˆåä¸€æ¬¡æ€§è¿”å›
- **æµå¼å“åº”**ï¼šå†…å®¹ç”Ÿæˆçš„åŒæ—¶å®æ—¶æ¨é€ç»™å®¢æˆ·ç«¯

### æµå¼å“åº”çš„ä¼˜åŠ¿

âœ… **æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ**ï¼šæ‰“å­—æœºæ•ˆæœï¼Œå®æ—¶åé¦ˆ  
âœ… **é™ä½å»¶è¿Ÿæ„ŸçŸ¥**ï¼šç”¨æˆ·ç«‹å³çœ‹åˆ°å“åº”å¼€å§‹  
âœ… **èŠ‚çœèµ„æº**ï¼šæ— éœ€ç­‰å¾…å®Œæ•´å“åº”  
âœ… **æ”¯æŒé•¿æ–‡æœ¬**ï¼šé€‚åˆç”Ÿæˆé•¿ç¯‡å†…å®¹  

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨åº”ç”¨

```bash
export OPENAI_API_KEY=sk-xxx
mvn spring-boot:run
```

### 2. æµ‹è¯•åŸºç¡€æµå¼å“åº”

```bash
curl -N -X POST http://localhost:8080/api/stream/basic \
  -H "Content-Type: application/json" \
  -d '{"message": "è¯·å†™ä¸€é¦–å…³äºæ˜¥å¤©çš„è¯—"}'
```

**æ³¨æ„**ï¼š`-N` å‚æ•°ç¦ç”¨ curl ç¼“å†²ï¼Œè®©ä½ èƒ½çœ‹åˆ°å®æ—¶æµå¼æ•ˆæœã€‚

## ğŸ“¡ API æ¥å£

### 1. åŸºç¡€æµå¼å“åº” (SSE)

```bash
curl -N -X POST http://localhost:8080/api/stream/basic \
  -H "Content-Type: application/json" \
  -d '{"message": "ä»‹ç»ä¸€ä¸‹ Spring AI"}'
```

**å“åº”æ ¼å¼**ï¼šServer-Sent Events (SSE)
```
data: Spring
data:  AI
data:  æ˜¯
data: ä¸€ä¸ª
...
```

### 2. åŸºç¡€æµå¼å“åº” (NDJSON)

```bash
curl -N -X POST http://localhost:8080/api/stream/basic/ndjson \
  -H "Content-Type: application/json" \
  -d '{"message": "ä»‹ç»ä¸€ä¸‹ Spring AI"}'
```

**å“åº”æ ¼å¼**ï¼šNewline Delimited JSON
```json
"Spring"
" AI"
" æ˜¯"
...
```

### 3. å¸¦å»¶è¿Ÿçš„æµå¼å“åº”ï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰

```bash
curl -N -X POST http://localhost:8080/api/stream/delayed \
  -H "Content-Type: application/json" \
  -d '{
    "message": "å†™ä¸€ä¸ªæ•…äº‹",
    "delayMillis": 100
  }'
```

æ¯ä¸ªå­—ç¬¦å»¶è¿Ÿ 100msï¼Œæ¨¡æ‹ŸçœŸå®çš„æ‰“å­—æ•ˆæœã€‚

### 4. å¸¦ç³»ç»Ÿæç¤ºè¯çš„æµå¼å“åº”

```bash
curl -N -X POST http://localhost:8080/api/stream/with-system \
  -H "Content-Type: application/json" \
  -d '{
    "systemPrompt": "ä½ æ˜¯ä¸€ä¸ªå¹½é»˜é£è¶£çš„åŠ©æ‰‹",
    "message": "ä»‹ç»ä¸€ä¸‹ Java"
  }'
```

### 5. å¤šè½®å¯¹è¯æµå¼å“åº”

```bash
curl -N -X POST http://localhost:8080/api/stream/conversation \
  -H "Content-Type: application/json" \
  -d '{
    "context": "ç”¨æˆ·åˆšæ‰é—®äº†å…³äº Python çš„é—®é¢˜",
    "message": "é‚£ Java å‘¢ï¼Ÿ"
  }'
```

### 6. å¸¦é€‰é¡¹çš„æµå¼å“åº”

```bash
curl -N -X POST http://localhost:8080/api/stream/with-options \
  -H "Content-Type: application/json" \
  -d '{
    "message": "å†™ä¸€ç¯‡æ–‡ç« ",
    "temperature": 0.9,
    "maxTokens": 500
  }'
```

### 7. æµå¼å“åº”è½¬æ¢ - æ·»åŠ å‰ç¼€

```bash
curl -N -X POST http://localhost:8080/api/stream/with-prefix \
  -H "Content-Type: application/json" \
  -d '{
    "message": "ä½ å¥½",
    "prefix": "[AIåŠ©æ‰‹] "
  }'
```

**å“åº”ç¤ºä¾‹**ï¼š
```
[AIåŠ©æ‰‹] ä½ å¥½ï¼æˆ‘æ˜¯ AI åŠ©æ‰‹...
```

### 8. æµå¼å“åº”è¿‡æ»¤

```bash
curl -N -X POST http://localhost:8080/api/stream/filtered \
  -H "Content-Type: application/json" \
  -d '{"message": "ä»‹ç» Spring Boot"}'
```

è‡ªåŠ¨è¿‡æ»¤ç©ºç™½å†…å®¹ã€‚

### 9. æµå¼å“åº”è®¡æ•°

```bash
curl -N -X POST http://localhost:8080/api/stream/with-count \
  -H "Content-Type: application/json" \
  -d '{"message": "å†™ä¸€æ®µä»£ç "}'
```

**å“åº”ç¤ºä¾‹**ï¼š
```
[å¼€å§‹] public
 class
 Hello
...
```

### 10. å¹¶è¡Œæµå¼å“åº”

```bash
curl -N -X POST http://localhost:8080/api/stream/parallel \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [
      "ä»€ä¹ˆæ˜¯ Javaï¼Ÿ",
      "ä»€ä¹ˆæ˜¯ Pythonï¼Ÿ",
      "ä»€ä¹ˆæ˜¯ JavaScriptï¼Ÿ"
    ]
  }'
```

åŒæ—¶è¯·æ±‚å¤šä¸ªé—®é¢˜ï¼Œäº¤é”™è¿”å›ç»“æœã€‚

### 11. æµå¼å“åº”ç¼“å†²

```bash
curl -N -X POST http://localhost:8080/api/stream/buffered \
  -H "Content-Type: application/json" \
  -d '{"message": "å†™ä¸€é¦–è¯—"}'
```

æŒ‰è¡Œç¼“å†²è¿”å›ï¼Œè€Œä¸æ˜¯é€å­—è¿”å›ã€‚

### 12. æµå¼å“åº”é”™è¯¯å¤„ç†

```bash
curl -N -X POST http://localhost:8080/api/stream/with-error-handling \
  -H "Content-Type: application/json" \
  -d '{"message": "æµ‹è¯•é”™è¯¯å¤„ç†"}'
```

ä¼˜é›…åœ°å¤„ç†æµå¼å“åº”ä¸­çš„é”™è¯¯ã€‚

## ğŸ¨ æµå¼å“åº”æ¨¡å¼

### 1. SSE (Server-Sent Events)

```java
@PostMapping(value = "/basic", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public Flux<String> basicStream(@RequestBody StreamRequest request) {
    return streamingService.basicStream(request.getMessage());
}
```

**ç‰¹ç‚¹**ï¼š
- æ ‡å‡†çš„ HTML5 æŠ€æœ¯
- è‡ªåŠ¨é‡è¿
- å•å‘é€šä¿¡ï¼ˆæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼‰
- æµè§ˆå™¨åŸç”Ÿæ”¯æŒ

### 2. NDJSON (Newline Delimited JSON)

```java
@PostMapping(value = "/basic/ndjson", produces = MediaType.APPLICATION_NDJSON_VALUE)
public Flux<String> basicStreamNdjson(@RequestBody StreamRequest request) {
    return streamingService.basicStream(request.getMessage());
}
```

**ç‰¹ç‚¹**ï¼š
- æ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡
- æ˜“äºè§£æ
- é€‚åˆç»“æ„åŒ–æ•°æ®æµ

### 3. WebFlux Flux

```java
public Flux<String> basicStream(String message) {
    return chatClient.prompt()
            .user(message)
            .stream()
            .content();
}
```

**ç‰¹ç‚¹**ï¼š
- Reactor å“åº”å¼æµ
- èƒŒå‹æ”¯æŒ
- ä¸°å¯Œçš„æ“ä½œç¬¦

## ğŸ’¡ é«˜çº§ç”¨æ³•

### 1. å»¶è¿Ÿå…ƒç´ ï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰

```java
public Flux<String> delayedStream(String message, long delayMillis) {
    return chatClient.prompt()
            .user(message)
            .stream()
            .content()
            .delayElements(Duration.ofMillis(delayMillis));
}
```

### 2. æµè½¬æ¢

```java
public Flux<String> streamWithPrefix(String message, String prefix) {
    return Flux.concat(
            Flux.just(prefix),
            chatClient.prompt()
                    .user(message)
                    .stream()
                    .content()
    );
}
```

### 3. æµè¿‡æ»¤

```java
public Flux<String> streamFiltered(String message) {
    return chatClient.prompt()
            .user(message)
            .stream()
            .content()
            .filter(chunk -> chunk != null && !chunk.trim().isEmpty());
}
```

### 4. æµç´¢å¼•

```java
public Flux<String> streamWithCount(String message) {
    return chatClient.prompt()
            .user(message)
            .stream()
            .content()
            .index()
            .map(tuple -> {
                long index = tuple.getT1();
                String content = tuple.getT2();
                return "[" + index + "] " + content;
            });
}
```

### 5. é”™è¯¯å¤„ç†

```java
public Flux<String> streamWithErrorHandling(String message) {
    return chatClient.prompt()
            .user(message)
            .stream()
            .content()
            .onErrorResume(error -> {
                log.error("æµå¼å“åº”é”™è¯¯: ", error);
                return Flux.just("[é”™è¯¯] " + error.getMessage());
            });
}
```

### 6. å¹¶è¡Œå¤„ç†

```java
public Flux<String> parallelStream(String... messages) {
    return Flux.fromArray(messages)
            .flatMap(message -> 
                chatClient.prompt()
                        .user(message)
                        .stream()
                        .content()
            );
}
```

## ğŸŒ å‰ç«¯é›†æˆ

### JavaScript (Fetch API)

```javascript
async function streamChat(message) {
    const response = await fetch('http://localhost:8080/api/stream/basic', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message })
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();

    while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value);
        console.log(chunk);
        // æ›´æ–° UI
    }
}
```

### JavaScript (EventSource - SSE)

```javascript
function streamChatSSE(message) {
    const eventSource = new EventSource(
        `http://localhost:8080/api/stream/basic?message=${encodeURIComponent(message)}`
    );

    eventSource.onmessage = (event) => {
        console.log(event.data);
        // æ›´æ–° UI
    };

    eventSource.onerror = (error) => {
        console.error('SSE Error:', error);
        eventSource.close();
    };
}
```

### React ç¤ºä¾‹

```jsx
function ChatComponent() {
    const [response, setResponse] = useState('');

    const streamChat = async (message) => {
        const res = await fetch('/api/stream/basic', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        });

        const reader = res.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            setResponse(prev => prev + chunk);
        }
    };

    return (
        <div>
            <button onClick={() => streamChat('ä½ å¥½')}>å‘é€</button>
            <div>{response}</div>
        </div>
    );
}
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æ¨¡å¼ | é¦–å­—èŠ‚æ—¶é—´ | æ€»æ—¶é—´ | ç”¨æˆ·ä½“éªŒ | èµ„æºå ç”¨ |
|------|-----------|--------|----------|----------|
| **ä¼ ç»Ÿå“åº”** | 5-10s | 5-10s | â­â­ | é«˜ |
| **æµå¼å“åº”** | <1s | 5-10s | â­â­â­â­â­ | ä½ |

## ğŸ”§ é…ç½®é€‰é¡¹

```yaml
spring:
  ai:
    openai:
      chat:
        options:
          stream: true  # å¯ç”¨æµå¼å“åº”
```

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **å®¢æˆ·ç«¯æ”¯æŒ**ï¼šç¡®ä¿å®¢æˆ·ç«¯æ”¯æŒæµå¼å“åº”
2. **è¶…æ—¶è®¾ç½®**ï¼šè°ƒæ•´è¶…æ—¶æ—¶é—´ä»¥é€‚åº”é•¿æ—¶é—´æµå¼å“åº”
3. **é”™è¯¯å¤„ç†**ï¼šä¼˜é›…å¤„ç†æµä¸­æ–­
4. **èƒŒå‹æ§åˆ¶**ï¼šé¿å…ç”Ÿäº§é€Ÿåº¦è¶…è¿‡æ¶ˆè´¹é€Ÿåº¦
5. **èµ„æºæ¸…ç†**ï¼šç¡®ä¿æµæ­£ç¡®å…³é—­

## ğŸ“ Reactor æ“ä½œç¬¦

### å¸¸ç”¨æ“ä½œç¬¦

| æ“ä½œç¬¦ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `map` | è½¬æ¢å…ƒç´  | `.map(s -> s.toUpperCase())` |
| `filter` | è¿‡æ»¤å…ƒç´  | `.filter(s -> !s.isEmpty())` |
| `flatMap` | æ‰å¹³åŒ–æ˜ å°„ | `.flatMap(s -> Flux.just(s.split(" ")))` |
| `delayElements` | å»¶è¿Ÿå…ƒç´  | `.delayElements(Duration.ofMillis(100))` |
| `buffer` | ç¼“å†²å…ƒç´  | `.buffer(10)` |
| `window` | çª—å£åŒ– | `.window(Duration.ofSeconds(1))` |
| `onErrorResume` | é”™è¯¯æ¢å¤ | `.onErrorResume(e -> Flux.just("error"))` |
| `retry` | é‡è¯• | `.retry(3)` |

## ğŸ“ æ€»ç»“

è¿™ä¸ª Streaming Demo å±•ç¤ºäº†ï¼š

âœ… **12 ç§æµå¼å“åº”æ¨¡å¼**ï¼šä»åŸºç¡€åˆ°é«˜çº§  
âœ… **SSE å’Œ NDJSON**ï¼šä¸¤ç§æµå¼æ ¼å¼  
âœ… **Reactor æ“ä½œç¬¦**ï¼šä¸°å¯Œçš„æµå¤„ç†èƒ½åŠ›  
âœ… **é”™è¯¯å¤„ç†**ï¼šä¼˜é›…çš„å¼‚å¸¸å¤„ç†  
âœ… **å‰ç«¯é›†æˆ**ï¼šJavaScript ç¤ºä¾‹  

é€šè¿‡æµå¼å“åº”ï¼Œä½ å¯ä»¥æ„å»ºå‡ºå“åº”è¿…é€Ÿã€ç”¨æˆ·ä½“éªŒä¼˜ç§€çš„ AI åº”ç”¨ï¼
