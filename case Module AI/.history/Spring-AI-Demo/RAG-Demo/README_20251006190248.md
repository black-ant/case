# RAG Demo - æ£€ç´¢å¢å¼ºç”Ÿæˆç¤ºä¾‹

è¿™ä¸ªé¡¹ç›®å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Spring AI å®ç° RAGï¼ˆRetrieval-Augmented Generationï¼Œæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰æ¶æ„ã€‚

## ğŸ¯ ä»€ä¹ˆæ˜¯ RAGï¼Ÿ

RAG æ˜¯ä¸€ç§ç»“åˆäº†æ£€ç´¢å’Œç”Ÿæˆçš„ AI æ¶æ„ï¼š

1. **æ£€ç´¢ï¼ˆRetrievalï¼‰**ï¼šä»çŸ¥è¯†åº“ä¸­æ£€ç´¢ç›¸å…³æ–‡æ¡£
2. **å¢å¼ºï¼ˆAugmentedï¼‰**ï¼šå°†æ£€ç´¢åˆ°çš„æ–‡æ¡£ä½œä¸ºä¸Šä¸‹æ–‡
3. **ç”Ÿæˆï¼ˆGenerationï¼‰**ï¼šåŸºäºä¸Šä¸‹æ–‡ç”Ÿæˆå‡†ç¡®çš„å›ç­”

### RAG çš„ä¼˜åŠ¿

âœ… **å‡†ç¡®æ€§**ï¼šåŸºäºçœŸå®æ–‡æ¡£ï¼Œå‡å°‘å¹»è§‰  
âœ… **æ—¶æ•ˆæ€§**ï¼šå¯ä»¥ä½¿ç”¨æœ€æ–°çš„æ–‡æ¡£  
âœ… **å¯è¿½æº¯**ï¼šå¯ä»¥å¼•ç”¨ä¿¡æ¯æ¥æº  
âœ… **æˆæœ¬æ•ˆç›Š**ï¼šæ— éœ€é‡æ–°è®­ç»ƒæ¨¡å‹  

## ğŸ—ï¸ æ¶æ„ç»„ä»¶

### 1. å‘é‡æ•°æ®åº“
- **Simple Vector Store**ï¼šå†…å­˜å­˜å‚¨ï¼Œé€‚åˆå¼€å‘æµ‹è¯•
- **PGVector**ï¼šPostgreSQL + pgvector æ‰©å±•ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒ

### 2. æ–‡æ¡£å¤„ç†
- **PDF æ–‡æ¡£**ï¼šä½¿ç”¨ PagePdfDocumentReader
- **Word æ–‡æ¡£**ï¼šä½¿ç”¨ TikaDocumentReader
- **æ–‡æœ¬æ–‡ä»¶**ï¼šä½¿ç”¨ TextReader

### 3. æ–‡æ¡£åˆ†å—
- **TokenTextSplitter**ï¼šæ™ºèƒ½åˆ†å—ï¼Œä¿æŒè¯­ä¹‰å®Œæ•´æ€§
- å¯é…ç½®å—å¤§å°ã€é‡å åº¦

### 4. RAG æ¨¡å¼
- åŸºç¡€ RAG
- å¸¦è¿‡æ»¤çš„ RAG
- å¤šæ­¥éª¤ RAG
- å¸¦å¼•ç”¨çš„ RAG

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. é…ç½®ç¯å¢ƒå˜é‡

```bash
# OpenAI API Key
export OPENAI_API_KEY=sk-xxx

# å‘é‡å­˜å‚¨ç±»å‹ï¼ˆsimple æˆ– pgvectorï¼‰
export VECTOR_STORE_TYPE=simple
```

### 2. å¯åŠ¨åº”ç”¨

```bash
mvn spring-boot:run
```

### 3. ä¸Šä¼ æ–‡æ¡£

```bash
# ä¸Šä¼ æ–‡æœ¬
curl -X POST http://localhost:8080/api/documents/ingest/text \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Spring AI ä»‹ç»",
    "text": "Spring AI æ˜¯ä¸€ä¸ªç”¨äºæ„å»º AI åº”ç”¨çš„æ¡†æ¶..."
  }'

# ä¸Šä¼ æ–‡ä»¶
curl -X POST http://localhost:8080/api/documents/upload \
  -F "file=@document.pdf"
```

### 4. æŸ¥è¯¢

```bash
curl -X POST http://localhost:8080/api/rag/query \
  -H "Content-Type: application/json" \
  -d '{
    "query": "ä»€ä¹ˆæ˜¯ Spring AIï¼Ÿ"
  }'
```

## ğŸ“¡ API æ¥å£

### æ–‡æ¡£ç®¡ç†

#### POST /api/documents/upload
ä¸Šä¼ å•ä¸ªæ–‡ä»¶

```bash
curl -X POST http://localhost:8080/api/documents/upload \
  -F "file=@document.pdf"
```

#### POST /api/documents/upload/batch
æ‰¹é‡ä¸Šä¼ æ–‡ä»¶

```bash
curl -X POST http://localhost:8080/api/documents/upload/batch \
  -F "files=@doc1.pdf" \
  -F "files=@doc2.txt"
```

#### POST /api/documents/ingest/text
æ‘„å–æ–‡æœ¬å†…å®¹

```bash
curl -X POST http://localhost:8080/api/documents/ingest/text \
  -H "Content-Type: application/json" \
  -d '{
    "title": "æˆ‘çš„æ–‡æ¡£",
    "text": "è¿™æ˜¯æ–‡æ¡£å†…å®¹..."
  }'
```

#### DELETE /api/documents/clear
æ¸…ç©ºå‘é‡æ•°æ®åº“

```bash
curl -X DELETE http://localhost:8080/api/documents/clear
```

### RAG æŸ¥è¯¢

#### POST /api/rag/query
åŸºç¡€ RAG æŸ¥è¯¢

```bash
curl -X POST http://localhost:8080/api/rag/query \
  -H "Content-Type: application/json" \
  -d '{
    "query": "ä»€ä¹ˆæ˜¯ Spring AIï¼Ÿ"
  }'
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "query": "ä»€ä¹ˆæ˜¯ Spring AIï¼Ÿ",
  "response": "Spring AI æ˜¯ä¸€ä¸ªç”¨äºæ„å»º AI åº”ç”¨çš„æ¡†æ¶...",
  "retrieved_documents": 3,
  "sources": ["spring-ai-intro.pdf", "spring-docs.txt"]
}
```

#### POST /api/rag/query/filtered
å¸¦è¿‡æ»¤çš„ RAG æŸ¥è¯¢

```bash
curl -X POST http://localhost:8080/api/rag/query/filtered \
  -H "Content-Type: application/json" \
  -d '{
    "query": "Spring Boot çš„ç‰¹æ€§",
    "source": "spring-boot-guide.pdf"
  }'
```

#### POST /api/rag/query/multi-step
å¤šæ­¥éª¤ RAG æŸ¥è¯¢ï¼ˆé€‚åˆå¤æ‚é—®é¢˜ï¼‰

```bash
curl -X POST http://localhost:8080/api/rag/query/multi-step \
  -H "Content-Type: application/json" \
  -d '{
    "query": "æ¯”è¾ƒ Spring AI å’Œ LangChain çš„ä¼˜ç¼ºç‚¹"
  }'
```

#### POST /api/rag/search
ç›¸ä¼¼åº¦æœç´¢ï¼ˆä¸ç”Ÿæˆå›ç­”ï¼‰

```bash
curl -X POST http://localhost:8080/api/rag/search \
  -H "Content-Type: application/json" \
  -d '{
    "query": "å‘é‡æ•°æ®åº“",
    "topK": 5
  }'
```

#### POST /api/rag/query/with-citations
å¸¦å¼•ç”¨çš„ RAG æŸ¥è¯¢

```bash
curl -X POST http://localhost:8080/api/rag/query/with-citations \
  -H "Content-Type: application/json" \
  -d '{
    "query": "Spring AI æ”¯æŒå“ªäº› LLMï¼Ÿ"
  }'
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "query": "Spring AI æ”¯æŒå“ªäº› LLMï¼Ÿ",
  "response": "Spring AI æ”¯æŒå¤šä¸ª LLM æä¾›å•† [1][2]ï¼ŒåŒ…æ‹¬ OpenAIã€Azure OpenAIã€Anthropic Claude ç­‰...",
  "citations": [
    {
      "source": "spring-ai-docs.pdf",
      "content_preview": "Spring AI æä¾›äº†ç»Ÿä¸€çš„ API..."
    }
  ]
}
```

## ğŸ”§ é…ç½®è¯´æ˜

### application.yml

```yaml
rag:
  # æ–‡æ¡£åˆ†å—é…ç½®
  chunking:
    chunk-size: 500          # æ¯å—å¤§å°
    chunk-overlap: 100       # å—ä¹‹é—´é‡å 
    min-chunk-size: 50       # æœ€å°å—å¤§å°
    max-chunk-size: 2000     # æœ€å¤§å—å¤§å°
  
  # æ£€ç´¢é…ç½®
  retrieval:
    top-k: 5                 # è¿”å›å‰ K ä¸ªç»“æœ
    similarity-threshold: 0.7 # ç›¸ä¼¼åº¦é˜ˆå€¼
  
  # å‘é‡å­˜å‚¨ç±»å‹
  vector-store:
    type: simple             # simple æˆ– pgvector
```

### ä½¿ç”¨ PGVectorï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

1. **å®‰è£… PostgreSQL å’Œ pgvector**

```bash
# å®‰è£… PostgreSQL
# å®‰è£… pgvector æ‰©å±•
CREATE EXTENSION vector;
```

2. **é…ç½®æ•°æ®åº“è¿æ¥**

```yaml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/vectordb
    username: postgres
    password: postgres

rag:
  vector-store:
    type: pgvector
    schema-name: ai_vectors
    table-name: document_embeddings
    dimensions: 1536
```

3. **å¯åŠ¨åº”ç”¨**

```bash
export VECTOR_STORE_TYPE=pgvector
mvn spring-boot:run
```

## ğŸ“š æ”¯æŒçš„æ–‡æ¡£æ ¼å¼

| æ ¼å¼ | æ‰©å±•å | Reader |
|------|--------|--------|
| PDF | .pdf | PagePdfDocumentReader |
| Word | .docx, .doc | TikaDocumentReader |
| æ–‡æœ¬ | .txt | TextReader |

## ğŸ’¡ ä½¿ç”¨åœºæ™¯

### 1. ä¼ä¸šçŸ¥è¯†åº“

```bash
# ä¸Šä¼ å…¬å¸æ–‡æ¡£
curl -X POST http://localhost:8080/api/documents/upload \
  -F "file=@company-handbook.pdf"

# å‘˜å·¥æŸ¥è¯¢
curl -X POST http://localhost:8080/api/rag/query \
  -H "Content-Type: application/json" \
  -d '{"query": "å…¬å¸çš„ä¼‘å‡æ”¿ç­–æ˜¯ä»€ä¹ˆï¼Ÿ"}'
```

### 2. æŠ€æœ¯æ–‡æ¡£åŠ©æ‰‹

```bash
# ä¸Šä¼ æŠ€æœ¯æ–‡æ¡£
curl -X POST http://localhost:8080/api/documents/upload/batch \
  -F "files=@spring-boot-docs.pdf" \
  -F "files=@spring-ai-docs.pdf"

# å¼€å‘è€…æŸ¥è¯¢
curl -X POST http://localhost:8080/api/rag/query \
  -H "Content-Type: application/json" \
  -d '{"query": "å¦‚ä½•é…ç½® Spring AI çš„å‘é‡æ•°æ®åº“ï¼Ÿ"}'
```

### 3. å®¢æœç³»ç»Ÿ

```bash
# ä¸Šä¼ äº§å“æ‰‹å†Œå’Œ FAQ
curl -X POST http://localhost:8080/api/documents/ingest/text \
  -H "Content-Type: application/json" \
  -d '{
    "title": "äº§å“ FAQ",
    "text": "Q: å¦‚ä½•é€€è´§ï¼Ÿ\nA: åœ¨æ”¶åˆ°å•†å“å 7 å¤©å†…..."
  }'

# å®¢æˆ·æŸ¥è¯¢
curl -X POST http://localhost:8080/api/rag/query/with-citations \
  -H "Content-Type: application/json" \
  -d '{"query": "æˆ‘æƒ³é€€è´§ï¼Œæ€ä¹ˆæ“ä½œï¼Ÿ"}'
```

## ğŸ¨ RAG å·¥ä½œæµç¨‹

```
1. æ–‡æ¡£æ‘„å–
   â”œâ”€â”€ ä¸Šä¼ æ–‡æ¡£ï¼ˆPDF/Word/TXTï¼‰
   â”œâ”€â”€ æ–‡æ¡£è§£æ
   â”œâ”€â”€ æ–‡æœ¬åˆ†å—ï¼ˆTokenTextSplitterï¼‰
   â”œâ”€â”€ ç”ŸæˆåµŒå…¥å‘é‡ï¼ˆEmbeddingï¼‰
   â””â”€â”€ å­˜å‚¨åˆ°å‘é‡æ•°æ®åº“

2. æŸ¥è¯¢å¤„ç†
   â”œâ”€â”€ ç”¨æˆ·æé—®
   â”œâ”€â”€ é—®é¢˜åµŒå…¥ï¼ˆEmbeddingï¼‰
   â”œâ”€â”€ å‘é‡ç›¸ä¼¼åº¦æœç´¢
   â”œâ”€â”€ æ£€ç´¢ç›¸å…³æ–‡æ¡£å—
   â””â”€â”€ è¿”å› Top-K ç»“æœ

3. ç­”æ¡ˆç”Ÿæˆ
   â”œâ”€â”€ æ„å»ºæç¤ºè¯ï¼ˆPromptï¼‰
   â”œâ”€â”€ æ·»åŠ æ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡
   â”œâ”€â”€ è°ƒç”¨ LLM ç”Ÿæˆå›ç­”
   â””â”€â”€ è¿”å›ç­”æ¡ˆå’Œå¼•ç”¨
```

## ğŸ” é«˜çº§ç‰¹æ€§

### 1. æ–‡æ¡£åˆ†å—ç­–ç•¥

```java
@Bean
public TokenTextSplitter tokenTextSplitter() {
    return new TokenTextSplitter(
        500,   // chunk size - æ¯å— 500 ä¸ª token
        100,   // overlap - é‡å  100 ä¸ª token
        50,    // min chunk size
        2000,  // max chunk size
        true   // keep separator
    );
}
```

**ä¸ºä»€ä¹ˆéœ€è¦é‡å ï¼Ÿ**
- ä¿æŒè¯­ä¹‰è¿è´¯æ€§
- é¿å…é‡è¦ä¿¡æ¯è¢«åˆ‡æ–­
- æé«˜æ£€ç´¢å‡†ç¡®æ€§

### 2. å…ƒæ•°æ®è¿‡æ»¤

```java
SearchRequest searchRequest = SearchRequest.query(query)
    .withTopK(5)
    .withFilterExpression("source == 'important-doc.pdf'");
```

### 3. å¤šæ­¥éª¤ RAG

é€‚åˆå¤æ‚é—®é¢˜ï¼š
1. å°†å¤æ‚é—®é¢˜åˆ†è§£æˆå­é—®é¢˜
2. åˆ†åˆ«æ£€ç´¢æ¯ä¸ªå­é—®é¢˜
3. ç»¼åˆæ‰€æœ‰ç»“æœç”Ÿæˆç­”æ¡ˆ

### 4. å¸¦å¼•ç”¨çš„å›ç­”

è®© AI åœ¨å›ç­”ä¸­æ ‡æ³¨ä¿¡æ¯æ¥æºï¼š
```
Spring AI æ”¯æŒå¤šä¸ª LLM [1][2]ï¼ŒåŒ…æ‹¬ï¼š
- OpenAI [1]
- Azure OpenAI [1]
- Anthropic Claude [2]

[1] spring-ai-docs.pdf
[2] llm-comparison.txt
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. æ‰¹é‡æ‘„å–

```bash
curl -X POST http://localhost:8080/api/documents/upload/batch \
  -F "files=@doc1.pdf" \
  -F "files=@doc2.pdf" \
  -F "files=@doc3.pdf"
```

### 2. è°ƒæ•´æ£€ç´¢å‚æ•°

```yaml
rag:
  retrieval:
    top-k: 3                    # å‡å°‘æ£€ç´¢æ•°é‡
    similarity-threshold: 0.8   # æé«˜ç›¸ä¼¼åº¦é˜ˆå€¼
```

### 3. ä½¿ç”¨ PGVector ç´¢å¼•

```sql
-- HNSW ç´¢å¼•ï¼ˆå¿«é€Ÿè¿‘ä¼¼æœç´¢ï¼‰
CREATE INDEX ON document_embeddings 
USING hnsw (embedding vector_cosine_ops);
```

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **æ–‡æ¡£è´¨é‡**ï¼šç¡®ä¿ä¸Šä¼ çš„æ–‡æ¡£å†…å®¹å‡†ç¡®ã€æ ¼å¼è§„èŒƒ
2. **åˆ†å—å¤§å°**ï¼šæ ¹æ®æ–‡æ¡£ç±»å‹è°ƒæ•´ chunk-size
3. **ç›¸ä¼¼åº¦é˜ˆå€¼**ï¼šè¿‡ä½ä¼šè¿”å›ä¸ç›¸å…³ç»“æœï¼Œè¿‡é«˜å¯èƒ½æ‰¾ä¸åˆ°ç»“æœ
4. **Token é™åˆ¶**ï¼šæ³¨æ„ LLM çš„ä¸Šä¸‹æ–‡çª—å£é™åˆ¶
5. **æˆæœ¬æ§åˆ¶**ï¼šEmbedding å’Œ LLM è°ƒç”¨éƒ½ä¼šäº§ç”Ÿè´¹ç”¨

## ğŸ”— å‚è€ƒèµ„æ–™

- [Spring AI RAG æ–‡æ¡£](https://docs.spring.io/spring-ai/reference/api/vectordbs.html)
- [PGVector æ–‡æ¡£](https://github.com/pgvector/pgvector)
- [RAG è®ºæ–‡](https://arxiv.org/abs/2005.11401)

## ğŸ“ æ€»ç»“

è¿™ä¸ª RAG Demo å±•ç¤ºäº†ï¼š

âœ… **å‘é‡æ•°æ®åº“é›†æˆ**ï¼šSimple Vector Store å’Œ PGVector  
âœ… **æ–‡æ¡£å¤„ç†**ï¼šæ”¯æŒ PDFã€Wordã€TXT  
âœ… **æ™ºèƒ½åˆ†å—**ï¼šTokenTextSplitter  
âœ… **å¤šç§ RAG æ¨¡å¼**ï¼šåŸºç¡€ã€è¿‡æ»¤ã€å¤šæ­¥éª¤ã€å¸¦å¼•ç”¨  
âœ… **å®Œæ•´çš„ API**ï¼šæ–‡æ¡£ç®¡ç†å’ŒæŸ¥è¯¢æ¥å£  

é€šè¿‡ RAGï¼Œä½ å¯ä»¥è®© AI åŸºäºä½ çš„ç§æœ‰çŸ¥è¯†åº“ç”Ÿæˆå‡†ç¡®ã€å¯è¿½æº¯çš„å›ç­”ï¼
