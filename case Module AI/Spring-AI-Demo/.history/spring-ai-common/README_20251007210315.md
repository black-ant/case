# Spring AI Common - 通用组件库

## 功能特性

### 1. API 审计日志 (API Audit Log)

自动记录所有 Controller API 的请求和响应信息，包括：
- 请求 ID（UUID）
- HTTP 方法和路径
- 请求参数（JSON 格式）
- 响应结果（JSON 格式）
- 执行时长（毫秒）
- 成功/失败状态
- 异常信息

## 使用方法

### 1. 添加依赖

在项目的 `pom.xml` 中添加：

```xml
<dependency>
    <groupId>com.example</groupId>
    <artifactId>spring-ai-common</artifactId>
    <version>1.0.0</version>
</dependency>
```

### 2. 启用审计日志

#### 方式一：在 Controller 类上添加注解（推荐）

```java
@RestController
@RequestMapping("/api/chat")
@ApiAuditLog  // 自动记录该 Controller 所有方法的审计日志
public class ChatController {
    
    @PostMapping("/simple")
    public String chat(@RequestBody String message) {
        return "响应内容";
    }
}
```

#### 方式二：在特定方法上添加注解

```java
@RestController
@RequestMapping("/api/chat")
public class ChatController {
    
    @PostMapping("/simple")
    @ApiAuditLog(value = "简单对话", logRequest = true, logResponse = true)
    public String chat(@RequestBody String message) {
        return "响应内容";
    }
    
    @GetMapping("/health")
    // 不添加注解，不记录审计日志
    public String health() {
        return "OK";
    }
}
```

### 3. 注解参数说明

```java
@ApiAuditLog(
    value = "操作描述",           // 可选，描述该 API 的功能
    logRequest = true,           // 是否记录请求参数，默认 true
    logResponse = true,          // 是否记录响应结果，默认 true
    logException = true          // 是否记录异常信息，默认 true
)
```

### 4. 日志输出示例

#### 同步请求日志

```
╔═══════════════════════════════════════════════════════════════
║ [AUDIT] Request ID: 550e8400-e29b-41d4-a716-446655440000
║ [AUDIT] Operation: POST /api/chat/simple
║ [AUDIT] Controller: ChatController.chat
║ [AUDIT] Request Body [0]: {"message":"你好"}
╚═══════════════════════════════════════════════════════════════

╔═══════════════════════════════════════════════════════════════
║ [AUDIT] Request ID: 550e8400-e29b-41d4-a716-446655440000
║ [AUDIT] Duration: 1234 ms
║ [AUDIT] Status: SUCCESS
║ [AUDIT] Response Body: {"response":"你好！有什么可以帮助你的吗？"}
╚═══════════════════════════════════════════════════════════════
```

#### 流式响应日志

```
[AUDIT] Request ID: 550e8400-e29b-41d4-a716-446655440000 - Stream started
[AUDIT] Request ID: 550e8400-e29b-41d4-a716-446655440000 - Stream completed in 2345 ms
```

#### 异常日志

```
╔═══════════════════════════════════════════════════════════════
║ [AUDIT] Request ID: 550e8400-e29b-41d4-a716-446655440000
║ [AUDIT] Duration: 567 ms
║ [AUDIT] Status: FAILED
║ [AUDIT] Error: Connection timeout
╚═══════════════════════════════════════════════════════════════
```

### 5. 支持的响应类型

- **同步响应**：普通对象、String、Map 等
- **响应式类型**：Mono<T>、Flux<T>
- **流式响应**：SSE (Server-Sent Events)、NDJSON

### 6. 自动配置

该组件使用 Spring Boot 自动配置，无需手动配置。只要添加依赖，就会自动启用。

如果需要禁用审计日志，可以在 `application.yml` 中配置：

```yaml
spring:
  autoconfigure:
    exclude:
      - com.example.common.audit.AuditAutoConfiguration
```

## 技术实现

- **AOP 切面**：使用 Spring AOP 拦截所有 Controller 方法
- **JSON 序列化**：使用 Jackson 将请求和响应转换为 JSON
- **响应式支持**：支持 Reactor 的 Mono 和 Flux 类型
- **性能优化**：异步记录日志，不影响业务性能

## 注意事项

1. **敏感信息**：审计日志会记录完整的请求和响应内容，请注意不要记录密码、Token 等敏感信息
2. **日志大小**：对于大型响应（超过 2000 字符），会自动截断
3. **性能影响**：审计日志对性能影响很小，但在高并发场景下建议配置异步日志
4. **日志级别**：审计日志使用 INFO 级别，异常使用 ERROR 级别

## 最佳实践

1. 在所有对外 API 的 Controller 类上添加 `@ApiAuditLog` 注解
2. 对于健康检查等不重要的接口，可以不添加注解
3. 配置日志输出到文件，便于后续审计和分析
4. 定期清理旧的审计日志文件
