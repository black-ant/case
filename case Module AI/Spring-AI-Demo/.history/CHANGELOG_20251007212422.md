# 更新日志

## 2025-10-07 - API 审计日志功能

### 新增功能

#### 1. 创建 spring-ai-common 通用组件库

新增了 `spring-ai-common` 模块，提供跨项目的通用功能：

- **ApiAuditLog 注解**：用于标记需要审计的 Controller
- **ApiAuditAspect 切面**：AOP 拦截器，自动记录请求和响应
- **AuditAutoConfiguration**：Spring Boot 自动配置
- **AuditLogInfo**：审计日志信息模型

#### 2. 审计日志功能特性

✅ **自动记录**：
- 请求 ID（UUID）
- HTTP 方法和路径
- Controller 类名和方法名
- 请求参数（完整 JSON）
- 响应结果（完整 JSON）
- 执行时长（毫秒）
- 成功/失败状态
- 异常信息

✅ **支持多种响应类型**：
- 同步响应（String, Object, Map 等）
- Mono<T>（响应式单值）
- Flux<T>（响应式流）
- SSE（Server-Sent Events）
- NDJSON

✅ **智能处理**：
- 自动脱敏（不记录 HttpServletRequest 等对象）
- 自动截断（响应超过 2000 字符）
- 性能优化（AOP 切面，影响极小）
- 精确追踪（每个请求唯一 Request ID）

#### 3. 更新所有项目

为所有项目添加了 `spring-ai-common` 依赖和 `@ApiAuditLog` 注解：

1. ✅ **Multi-LLM-Provider**
   - LLMController

2. ✅ **Function-Calling-Demo**
   - FunctionCallingController
   - DynamicFunctionController

3. ✅ **Agent-Workflow-Demo**
   - WorkflowController

4. ✅ **Sample-Spring-AI**
   - ChatController
   - AdvancedChatController

5. ✅ **RAG-Demo**
   - RAGController
   - DocumentController

6. ✅ **Prompt-Engineering-Demo**
   - PromptController

7. ✅ **Streaming-Demo**
   - StreamingController

### 项目清理

删除了 30 个不必要的文件：
- ❌ 测试批处理文件（*.bat）
- ❌ 测试脚本文件（*.sh, *.ps1, *.py）
- ❌ 演示 HTML 文件（demo.html）
- ❌ 重复的文档文件（LOGGING_*.md, PROJECT-STATUS.md 等）
- ❌ 临时文本文件（*.txt）
- ❌ 示例配置文件（.env.example）

### 技术实现

**核心技术栈**：
- Spring AOP（切面编程）
- Spring Boot Auto-Configuration（自动配置）
- Jackson（JSON 序列化）
- Project Reactor（响应式支持）
- Lombok（代码简化）

**设计模式**：
- AOP 切面模式
- 注解驱动配置
- 自动配置模式

### 文档

新增文档：
- `spring-ai-common/README.md` - 详细的技术文档和使用指南
- `AUDIT_LOG_GUIDE.md` - 审计日志使用指南和测试方法
- `CHANGELOG.md` - 本更新日志

### 使用方法

#### 1. 在 Controller 类上添加注解

```java
@RestController
@RequestMapping("/api/chat")
@ApiAuditLog  // 自动记录所有方法的审计日志
public class ChatController {
    // ...
}
```

#### 2. 查看日志输出

```
╔═══════════════════════════════════════════════════════════════
║ [AUDIT] Request ID: 550e8400-e29b-41d4-a716-446655440000
║ [AUDIT] Operation: POST /api/chat/simple
║ [AUDIT] Controller: ChatController.chat
║ [AUDIT] Request Body [0]: {"message":"你好"}
╚═══════════════════════════════════════════════════════════════

╔═══════════════════════════════════════════════════════════════
║ [AUDIT] Request ID: 550e8400-e29b-41d4-a716-446655440000
║ [AUDIT] Duration: 1234 ms
║ [AUDIT] Status: SUCCESS
║ [AUDIT] Response Body: {"response":"你好！"}
╚═══════════════════════════════════════════════════════════════
```

### 兼容性

- ✅ Java 17+
- ✅ Spring Boot 3.2.5
- ✅ Spring AI 1.0.0-M4
- ✅ 所有现有项目

### 性能影响

- 对业务性能影响极小（< 1ms）
- 使用 AOP 切面，不侵入业务代码
- 支持异步日志配置

### 下一步建议

1. 配置日志文件滚动策略
2. 添加日志分析和监控
3. 考虑将审计日志输出到专门的审计系统
4. 根据需要调整日志级别和格式

### 相关链接

- [Spring AOP 文档](https://docs.spring.io/spring-framework/reference/core/aop.html)
- [Spring Boot Auto-Configuration](https://docs.spring.io/spring-boot/reference/using/auto-configuration.html)
- [Project Reactor](https://projectreactor.io/)
