# AI 智能客服系统

这是一个集成了 Spring AI 多项功能的完整 AI 客服系统，展示了如何构建一个生产级的智能客服应用。

## 🎯 功能特性

### 1. RAG（检索增强生成）
- 内置知识库，包含产品政策、FAQ 等信息
- 使用向量存储进行语义搜索
- 自动将相关知识注入到对话上下文中

### 2. Function Calling（工具调用）
- **订单查询**：通过订单号或客户ID查询订单信息
- **物流追踪**：查询订单的物流状态和追踪号
- **工单创建**：自动创建客服工单记录问题
- **工单查询**：查看客户的历史工单

### 3. Streaming（流式响应）
- 支持 SSE（Server-Sent Events）流式输出
- 实时显示 AI 回复，提升用户体验
- 可切换流式/非流式模式

### 4. Prompt Engineering（提示工程）
- 专业的客服系统提示词
- 礼貌、专业的对话风格
- 结构化的问题解决流程

### 5. Agent Workflow（智能工作流）
- 多步骤问题解决
- 自动选择合适的工具
- 上下文感知的对话管理

### 6. 会话管理
- 持久化聊天历史
- 会话状态跟踪
- 支持多轮对话

### 7. 审计日志
- 集成 spring-ai-common 的审计功能
- 记录所有 API 调用
- 便于问题追踪和分析

## 🏗️ 项目结构

```
AI-Customer-Service/
├── src/main/java/com/example/customerservice/
│   ├── config/              # 配置类
│   │   ├── DataInitializer.java
│   │   ├── FunctionConfig.java
│   │   └── VectorStoreConfig.java
│   ├── controller/          # 控制器
│   │   └── CustomerServiceController.java
│   ├── dto/                 # 数据传输对象
│   │   ├── ChatRequest.java
│   │   └── ChatResponse.java
│   ├── entity/              # 实体类
│   │   ├── ChatMessage.java
│   │   ├── ChatSession.java
│   │   ├── CustomerTicket.java
│   │   └── Order.java
│   ├── function/            # Function Calling 工具
│   │   ├── OrderQueryFunction.java
│   │   ├── TicketCreateFunction.java
│   │   ├── TicketQueryFunction.java
│   │   └── TrackingQueryFunction.java
│   ├── repository/          # 数据访问层
│   │   ├── ChatMessageRepository.java
│   │   ├── ChatSessionRepository.java
│   │   ├── CustomerTicketRepository.java
│   │   └── OrderRepository.java
│   ├── service/             # 服务层
│   │   ├── CustomerServiceAgent.java
│   │   └── KnowledgeBaseService.java
│   └── AiCustomerServiceApplication.java
└── src/main/resources/
    ├── application.yml
    └── static/
        └── index.html       # Web 界面
```

## 🚀 快速开始

### 前置要求

- JDK 17+
- Maven 3.6+
- OpenAI API Key

### 配置

1. 设置环境变量：
```bash
export OPENAI_API_KEY=your-api-key-here
```

或在 `application.yml` 中配置：
```yaml
spring:
  ai:
    openai:
      api-key: your-api-key-here
```

### 运行

```bash
cd AI-Customer-Service
mvn spring-boot:run
```

### 访问

打开浏览器访问：http://localhost:8080

## 📡 API 接口

### 1. 创建会话
```http
POST /api/customer-service/session
Content-Type: application/json

{
  "customerId": "CUST001",
  "customerName": "张三"
}
```

### 2. 发送消息（非流式）
```http
POST /api/customer-service/chat
Content-Type: application/json

{
  "sessionId": "xxx-xxx-xxx",
  "customerId": "CUST001",
  "message": "我想查询订单"
}
```

### 3. 发送消息（流式）
```http
POST /api/customer-service/chat/stream
Content-Type: application/json

{
  "sessionId": "xxx-xxx-xxx",
  "customerId": "CUST001",
  "message": "我想查询订单"
}
```

### 4. 结束会话
```http
POST /api/customer-service/session/{sessionId}/end
```

## 💡 使用示例

### 示例对话 1：查询订单
```
用户：我想查询我的订单
AI：好的，我来帮您查询订单信息。请问您的订单号是多少？或者我可以帮您查询所有订单。

用户：查询我的所有订单
AI：[调用 orderQueryFunction]
    您好！我为您查询到以下订单：
    1. 订单号：ORD20251019001
       商品：iPhone 15 Pro
       状态：已发货
       物流单号：SF1234567890
    
    2. 订单号：ORD20251019002
       商品：AirPods Pro
       状态：已送达
```

### 示例对话 2：查询政策
```
用户：退货政策是什么？
AI：[从知识库检索]
    根据我们的退货政策：
    - 商品自收到之日起30天内可无理由退货
    - 退货商品需保持原包装完好，未使用
    - 退款将在收到退货后3-5个工作日内处理
    
    如果您需要退货，我可以帮您创建退货工单。
```

### 示例对话 3：创建工单
```
用户：我收到的商品有质量问题
AI：非常抱歉给您带来不便。我来帮您创建一个工单，我们的客服团队会尽快处理。
    请问具体是什么问题呢？

用户：屏幕有划痕
AI：[调用 ticketCreateFunction]
    工单已创建成功！
    工单号：12345
    我们的客服团队会在24小时内联系您处理此问题。
```

## 🔧 自定义扩展

### 添加新的 Function
1. 在 `function` 包下创建新的 Function 类
2. 实现 `Function<Request, Response>` 接口
3. 在 `FunctionConfig` 中注册 Bean
4. 添加 `@Description` 注解描述功能

### 扩展知识库
在 `KnowledgeBaseService.initKnowledgeBase()` 中添加更多文档：
```java
new Document(
    "您的知识内容",
    Map.of("category", "分类", "type", "类型")
)
```

### 自定义提示词
修改 `CustomerServiceAgent.SYSTEM_PROMPT` 常量。

## 📊 数据库

系统使用 H2 内存数据库，包含以下表：
- `chat_sessions` - 会话记录
- `chat_messages` - 消息记录
- `orders` - 订单信息
- `customer_tickets` - 客服工单

访问 H2 控制台：http://localhost:8080/h2-console
- JDBC URL: `jdbc:h2:mem:customerservice`
- Username: `sa`
- Password: (空)

## 🎨 前端界面

系统提供了一个现代化的 Web 界面：
- 渐变色设计
- 流畅的动画效果
- 支持流式/非流式切换
- 快捷操作按钮
- 响应式布局

## 🔍 测试数据

系统启动时会自动创建测试数据：
- 客户：张三 (CUST001)、李四 (CUST002)
- 订单：3个测试订单，包含不同状态

## 📝 技术栈

- Spring Boot 3.x
- Spring AI
- Spring Data JPA
- H2 Database
- WebFlux (流式响应)
- OpenAI GPT-4
- Lombok

## 🤝 集成的 Demo 功能

本项目整合了以下 Demo 的功能：
- ✅ RAG-Demo - 知识库检索
- ✅ Function-Calling-Demo - 工具调用
- ✅ Streaming-Demo - 流式响应
- ✅ Prompt-Engineering-Demo - 提示工程
- ✅ Agent-Workflow-Demo - 智能工作流
- ✅ spring-ai-common - 审计日志

## 📄 许可证

MIT License
