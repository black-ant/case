# 系统架构说明

## 📐 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        前端界面 (Web UI)                      │
│                    index.html + JavaScript                   │
└────────────────────────┬────────────────────────────────────┘
                         │ HTTP/SSE
┌────────────────────────▼────────────────────────────────────┐
│                   Controller 层                              │
│              CustomerServiceController                       │
│         (处理 HTTP 请求，支持流式/非流式)                      │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────┐
│                    Service 层                                │
│  ┌──────────────────────────────────────────────────────┐  │
│  │         CustomerServiceAgent (核心代理)               │  │
│  │  - 会话管理                                           │  │
│  │  - 消息历史                                           │  │
│  │  - AI 调用编排                                        │  │
│  │  - Function Calling 集成                             │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │         KnowledgeBaseService (知识库)                 │  │
│  │  - 向量存储                                           │  │
│  │  - 语义搜索                                           │  │
│  │  - 上下文增强                                         │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────────┘
                         │
        ┌────────────────┼────────────────┐
        │                │                │
┌───────▼──────┐  ┌──────▼──────┐  ┌─────▼──────┐
│ Spring AI    │  │  Function   │  │ Repository │
│ ChatClient   │  │  Calling    │  │    层      │
│              │  │             │  │            │
│ - OpenAI     │  │ - 订单查询  │  │ - JPA      │
│ - Streaming  │  │ - 物流追踪  │  │ - H2 DB    │
│ - RAG        │  │ - 工单创建  │  │            │
└──────────────┘  └─────────────┘  └────────────┘
```

## 🔄 核心流程

### 1. 会话创建流程
```
用户请求 → Controller.createSession()
         → CustomerServiceAgent.createSession()
         → 生成 sessionId
         → 保存到 ChatSession 表
         → 返回 sessionId
```

### 2. 消息处理流程（非流式）
```
用户消息 → Controller.chat()
         → CustomerServiceAgent.chat()
         → 保存用户消息
         → 构建消息历史
         ↓
         检索知识库 (KnowledgeBaseService)
         ↓
         调用 ChatClient
         ├─ 注入系统提示词
         ├─ 注入知识库上下文
         ├─ 注入历史消息
         └─ 注册 Function Calling
         ↓
         AI 处理
         ├─ 可能调用 Function (订单查询/工单创建等)
         └─ 生成回复
         ↓
         保存助手消息
         → 返回响应
```

### 3. 消息处理流程（流式）
```
用户消息 → Controller.chatStream()
         → CustomerServiceAgent.chatStream()
         → 保存用户消息
         → 构建消息历史
         → 检索知识库
         ↓
         调用 ChatClient.stream()
         ↓
         返回 Flux<String>
         ↓
         逐块发送到前端 (SSE)
         ↓
         流式完成后保存完整消息
```

## 🧩 核心组件

### 1. CustomerServiceAgent
**职责：**
- 会话生命周期管理
- 消息历史维护
- AI 调用编排
- Function Calling 集成

**关键方法：**
- `createSession()` - 创建新会话
- `chat()` - 处理消息（非流式）
- `chatStream()` - 处理消息（流式）
- `buildMessageHistory()` - 构建上下文
- `endSession()` - 结束会话

### 2. KnowledgeBaseService
**职责：**
- 初始化知识库
- 向量化文档
- 语义搜索
- 上下文增强

**关键方法：**
- `initKnowledgeBase()` - 初始化知识
- `searchKnowledge()` - 搜索相关知识
- `getKnowledgeContext()` - 获取上下文

### 3. Function Calling 工具

#### OrderQueryFunction
- 查询订单信息
- 支持按订单号或客户ID查询

#### TrackingQueryFunction
- 查询物流信息
- 返回追踪号和状态

#### TicketCreateFunction
- 创建客服工单
- 记录问题详情

#### TicketQueryFunction
- 查询客户工单列表
- 查看工单状态

## 💾 数据模型

### ChatSession (会话)
```
- sessionId: 会话ID (UUID)
- customerId: 客户ID
- customerName: 客户名称
- startTime: 开始时间
- endTime: 结束时间
- status: 状态 (ACTIVE/ENDED)
- messageCount: 消息数量
```

### ChatMessage (消息)
```
- sessionId: 所属会话
- role: 角色 (USER/ASSISTANT/SYSTEM)
- content: 消息内容
- timestamp: 时间戳
- functionCalled: 调用的函数
```

### Order (订单)
```
- orderNumber: 订单号
- customerId: 客户ID
- productName: 商品名称
- status: 状态
- trackingNumber: 物流单号
```

### CustomerTicket (工单)
```
- customerId: 客户ID
- title: 标题
- description: 描述
- status: 状态 (OPEN/IN_PROGRESS/RESOLVED/CLOSED)
- priority: 优先级
```

## 🔧 技术选型

### Spring AI
- **ChatClient**: 统一的 AI 调用接口
- **Function Calling**: 工具调用能力
- **VectorStore**: 向量存储（RAG）
- **Streaming**: 流式响应支持

### Spring Boot
- **WebFlux**: 响应式编程，支持 SSE
- **Data JPA**: 数据持久化
- **H2**: 内存数据库

### 前端
- **原生 JavaScript**: 无框架依赖
- **Fetch API**: HTTP 请求
- **EventSource**: SSE 流式接收（可选）

## 🎯 设计模式

### 1. 策略模式
- 流式 vs 非流式响应
- 不同的 Function 实现

### 2. 模板方法模式
- `buildMessageHistory()` 构建标准消息流程

### 3. 工厂模式
- ChatClient 的构建和配置

### 4. 观察者模式
- 流式响应的事件处理

## 🚀 性能优化

### 1. 消息历史限制
- 只保留最近 10 条消息
- 避免上下文过长

### 2. 知识库检索
- Top-K 限制（默认 3）
- 向量化缓存

### 3. 流式响应
- 减少首字延迟
- 提升用户体验

### 4. 数据库索引
- sessionId 索引
- orderNumber 索引
- customerId 索引

## 🔐 安全考虑

### 1. API Key 保护
- 环境变量存储
- 不提交到代码库

### 2. 输入验证
- 参数校验
- SQL 注入防护（JPA）

### 3. 会话隔离
- 每个会话独立
- 不跨会话访问数据

## 📈 扩展性

### 1. 水平扩展
- 无状态设计
- 会话数据持久化
- 可部署多实例

### 2. 功能扩展
- 新增 Function 只需实现接口
- 知识库可动态更新
- 支持多种 LLM 提供商

### 3. 存储扩展
- 可替换为 PostgreSQL + PGVector
- 可接入 Redis 缓存
- 可使用专业向量数据库

## 🔍 监控与日志

### 1. 审计日志
- 集成 spring-ai-common
- 记录所有 API 调用

### 2. 业务日志
- 会话创建/结束
- Function 调用
- 错误异常

### 3. 性能监控
- 响应时间
- Token 使用量
- 数据库查询

## 📚 最佳实践

### 1. Prompt Engineering
- 清晰的系统提示词
- 结构化的指令
- 示例驱动

### 2. RAG 优化
- 高质量的知识库内容
- 合理的分块策略
- 相关性排序

### 3. Function Calling
- 明确的函数描述
- 结构化的参数定义
- 错误处理

### 4. 用户体验
- 流式响应提升感知速度
- 快捷操作减少输入
- 友好的错误提示
