# 审计日志测试指南

## 快速测试

### 1. 启动项目

选择任意一个项目启动，例如 Multi-LLM-Provider：

```bash
cd Multi-LLM-Provider
mvn spring-boot:run
```

### 2. 发送测试请求

#### 测试同步请求

```bash
curl -X POST http://localhost:8080/api/llm/openai/chat \
  -H "Content-Type: application/json" \
  -d '{"message":"你好，请介绍一下 Spring AI"}'
```

**预期日志输出**：

```
╔═══════════════════════════════════════════════════════════════
║ [AUDIT] Request ID: 550e8400-e29b-41d4-a716-446655440000
║ [AUDIT] Operation: POST /api/llm/openai/chat
║ [AUDIT] Controller: LLMController.openaiChat
║ [AUDIT] Request Body [0]: {"message":"你好，请介绍一下 Spring AI"}
╚═══════════════════════════════════════════════════════════════

╔═══════════════════════════════════════════════════════════════
║ [AUDIT] Request ID: 550e8400-e29b-41d4-a716-446655440000
║ [AUDIT] Duration: 1234 ms
║ [AUDIT] Status: SUCCESS
║ [AUDIT] Response Body: {"provider":"OpenAI","model":"gpt-3.5-turbo","response":"...","duration":1234}
╚═══════════════════════════════════════════════════════════════
```

#### 测试流式请求

```bash
curl -X POST http://localhost:8080/api/llm/openai/stream \
  -H "Content-Type: application/json" \
  -d '{"message":"写一首关于春天的诗"}'
```

**预期日志输出**：

```
╔═══════════════════════════════════════════════════════════════
║ [AUDIT] Request ID: 550e8400-e29b-41d4-a716-446655440001
║ [AUDIT] Operation: POST /api/llm/openai/stream
║ [AUDIT] Controller: LLMController.openaiStreamChat
║ [AUDIT] Request Body [0]: {"message":"写一首关于春天的诗"}
╚═══════════════════════════════════════════════════════════════

[AUDIT] Request ID: 550e8400-e29b-41d4-a716-446655440001 - Stream started
[AUDIT] Request ID: 550e8400-e29b-41d4-a716-446655440001 - Stream completed in 2345 ms
```

#### 测试健康检查（不记录审计日志）

```bash
curl http://localhost:8080/api/llm/health
```

**预期**：不会有审计日志输出（因为 health 方法没有添加 @ApiAuditLog 注解）

### 3. 测试其他项目

#### Function-Calling-Demo

```bash
cd Function-Calling-Demo
mvn spring-boot:run

# 测试单个函数调用
curl -X POST http://localhost:8080/api/function/single \
  -H "Content-Type: application/json" \
  -d '{"message":"今天天气怎么样？","functionName":"getWeather"}'
```

#### Agent-Workflow-Demo

```bash
cd Agent-Workflow-Demo
mvn spring-boot:run

# 测试链式工作流
curl -X POST http://localhost:8080/api/workflow/chain/execute \
  -H "Content-Type: application/json" \
  -d '{"input":"分析这篇文章","steps":["提取关键词","总结内容","生成标题"]}'
```

#### Sample-Spring-AI

```bash
cd Sample-Spring-AI
mvn spring-boot:run

# 测试简单对话
curl -X POST http://localhost:8080/api/chat/simple \
  -H "Content-Type: application/json" \
  -d "你好，Spring AI"

# 测试流式对话
curl -X POST http://localhost:8080/api/chat/stream \
  -H "Content-Type: application/json" \
  -d "讲一个故事"
```

#### RAG-Demo

```bash
cd RAG-Demo
mvn spring-boot:run

# 测试 RAG 查询
curl -X POST http://localhost:8080/api/rag/query \
  -H "Content-Type: application/json" \
  -d '{"query":"什么是向量数据库？"}'
```

#### Prompt-Engineering-Demo

```bash
cd Prompt-Engineering-Demo
mvn spring-boot:run

# 测试带记忆的对话
curl -X POST http://localhost:8080/api/prompt/memory/chat \
  -H "Content-Type: application/json" \
  -d '{"sessionId":"test-session-001","message":"我叫张三"}'
```

#### Streaming-Demo

```bash
cd Streaming-Demo
mvn spring-boot:run

# 测试基础流式响应
curl -X POST http://localhost:8080/api/stream/basic \
  -H "Content-Type: application/json" \
  -d '{"message":"介绍一下 Reactor"}'
```

## 验证要点

### ✅ 检查项

1. **请求日志**：
   - 是否包含 Request ID
   - 是否记录了完整的请求参数
   - 是否显示了 Controller 和方法名

2. **响应日志**：
   - 是否包含相同的 Request ID
   - 是否记录了执行时长
   - 是否记录了完整的响应内容
   - 是否显示了成功/失败状态

3. **流式响应**：
   - 是否记录了 Stream started
   - 是否记录了 Stream completed
   - 是否包含总执行时长

4. **异常处理**：
   - 当 API 调用失败时，是否记录了错误信息
   - 是否显示 Status: FAILED

## 日志级别调整

如果看不到审计日志，检查 `application.yml` 配置：

```yaml
logging:
  level:
    com.example.common.audit: INFO  # 确保是 INFO 或 DEBUG
    root: INFO
```

## 常见问题

### Q1: 看不到审计日志？

**解决方案**：
1. 检查日志级别是否为 INFO 或以上
2. 确认 Controller 类或方法上有 `@ApiAuditLog` 注解
3. 确认项目已添加 `spring-ai-common` 依赖

### Q2: 日志格式不对？

**解决方案**：
1. 检查是否使用了自定义的日志配置
2. 确认 Logback 或 Log4j2 配置正确

### Q3: 性能影响？

**解决方案**：
1. 审计日志对性能影响极小（< 1ms）
2. 如果需要，可以配置异步日志
3. 可以通过注解参数控制是否记录请求/响应

### Q4: 如何禁用某个接口的审计日志？

**解决方案**：
1. 不在该方法上添加 `@ApiAuditLog` 注解
2. 或者在类级别添加注解，方法级别覆盖：

```java
@RestController
@ApiAuditLog
public class MyController {
    
    @GetMapping("/important")
    public String important() {
        // 会记录审计日志
    }
    
    @GetMapping("/health")
    @ApiAuditLog(logRequest = false, logResponse = false)
    public String health() {
        // 不记录审计日志
    }
}
```

## 高级用法

### 自定义操作描述

```java
@PostMapping("/chat")
@ApiAuditLog(value = "AI 对话接口", logRequest = true, logResponse = true)
public String chat(@RequestBody String message) {
    // ...
}
```

### 只记录请求，不记录响应

```java
@PostMapping("/upload")
@ApiAuditLog(logRequest = true, logResponse = false)
public String upload(@RequestParam MultipartFile file) {
    // 适用于上传大文件的场景
}
```

### 只记录异常

```java
@PostMapping("/risky")
@ApiAuditLog(logRequest = false, logResponse = false, logException = true)
public String risky() {
    // 只在出错时记录日志
}
```

## 总结

审计日志功能已经完全集成到所有项目中，开箱即用。只需启动项目并发送请求，就能在控制台看到详细的审计日志输出。
