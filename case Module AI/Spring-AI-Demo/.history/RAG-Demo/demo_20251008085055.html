<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Demo - æ£€ç´¢å¢å¼ºç”Ÿæˆæ¼”ç¤º</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 30px; text-align: center; }
        .demo-section { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .demo-section h2 { color: #2c3e50; margin-bottom: 15px; font-size: 18px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #555; font-weight: 500; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        textarea { min-height: 100px; resize: vertical; font-family: inherit; }
        button { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 10px; }
        button:hover { background: #229954; }
        button.danger { background: #e74c3c; }
        button.danger:hover { background: #c0392b; }
        .response { margin-top: 15px; padding: 15px; background: #f8f9fa; border-left: 4px solid #27ae60; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; }
        .error { border-left-color: #e74c3c; background: #fee; }
        .loading { color: #27ae60; font-style: italic; }
        .file-input { padding: 8px; }
        .sources { margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 4px; }
        .source-item { margin: 5px 0; padding: 5px; background: white; border-radius: 3px; font-size: 13px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“š RAG Demo - æ£€ç´¢å¢å¼ºç”Ÿæˆæ¼”ç¤º</h1>

        <!-- æ–‡æ¡£ä¸Šä¼  -->
        <div class="demo-section">
            <h2>1. æ–‡æ¡£ç®¡ç†</h2>
            <div class="input-group">
                <label>ä¸Šä¼ æ–‡ä»¶ï¼ˆPDF/TXT/DOCXï¼‰ï¼š</label>
                <input type="file" id="fileUpload" class="file-input" accept=".pdf,.txt,.docx">
                <button onclick="uploadFile()">ä¸Šä¼ æ–‡ä»¶</button>
            </div>
            <div class="input-group">
                <label>æˆ–ç›´æ¥è¾“å…¥æ–‡æœ¬ï¼š</label>
                <input type="text" id="textTitle" placeholder="æ–‡æ¡£æ ‡é¢˜">
                <textarea id="textContent" placeholder="æ–‡æ¡£å†…å®¹..."></textarea>
                <button onclick="ingestText()">æ·»åŠ æ–‡æœ¬</button>
                <button class="danger" onclick="clearDocuments()">æ¸…ç©ºæ‰€æœ‰æ–‡æ¡£</button>
            </div>
            <div id="uploadResponse"></div>
        </div>

        <!-- åŸºç¡€ RAG æŸ¥è¯¢ -->
        <div class="demo-section">
            <h2>2. åŸºç¡€ RAG æŸ¥è¯¢</h2>
            <div class="input-group">
                <label>è¾“å…¥é—®é¢˜ï¼š</label>
                <textarea id="queryBasic" placeholder="ä¾‹å¦‚ï¼šä»€ä¹ˆæ˜¯ Spring AIï¼Ÿ"></textarea>
            </div>
            <button onclick="queryBasic()">æŸ¥è¯¢</button>
            <div id="queryBasicResponse"></div>
        </div>

        <!-- ç›¸ä¼¼åº¦æœç´¢ -->
        <div class="demo-section">
            <h2>3. ç›¸ä¼¼åº¦æœç´¢ï¼ˆä¸ç”Ÿæˆå›ç­”ï¼‰</h2>
            <div class="input-group">
                <label>æœç´¢å…³é”®è¯ï¼š</label>
                <input type="text" id="searchQuery" placeholder="ä¾‹å¦‚ï¼šå‘é‡æ•°æ®åº“">
                <label>è¿”å›ç»“æœæ•°é‡ï¼š</label>
                <input type="number" id="searchTopK" value="5" min="1" max="10">
            </div>
            <button onclick="searchSimilar()">æœç´¢</button>
            <div id="searchResponse"></div>
        </div>

        <!-- å¸¦å¼•ç”¨çš„æŸ¥è¯¢ -->
        <div class="demo-section">
            <h2>4. å¸¦å¼•ç”¨çš„ RAG æŸ¥è¯¢</h2>
            <div class="input-group">
                <label>è¾“å…¥é—®é¢˜ï¼š</label>
                <textarea id="queryCitation" placeholder="ä¾‹å¦‚ï¼šSpring AI æ”¯æŒå“ªäº› LLMï¼Ÿ"></textarea>
            </div>
            <button onclick="queryCitation()">æŸ¥è¯¢ï¼ˆå¸¦å¼•ç”¨ï¼‰</button>
            <div id="queryCitationResponse"></div>
        </div>

        <!-- å¤šæ­¥éª¤æŸ¥è¯¢ -->
        <div class="demo-section">
            <h2>5. å¤šæ­¥éª¤ RAG æŸ¥è¯¢ï¼ˆå¤æ‚é—®é¢˜ï¼‰</h2>
            <div class="input-group">
                <label>è¾“å…¥å¤æ‚é—®é¢˜ï¼š</label>
                <textarea id="queryMultiStep" placeholder="ä¾‹å¦‚ï¼šæ¯”è¾ƒ Spring AI å’Œ LangChain çš„ä¼˜ç¼ºç‚¹"></textarea>
            </div>
            <button onclick="queryMultiStep()">æ·±åº¦åˆ†æ</button>
            <div id="queryMultiStepResponse"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8083/api';

        async function uploadFile() {
            const fileInput = document.getElementById('fileUpload');
            const file = fileInput.files[0];
            if (!file) return alert('è¯·é€‰æ‹©æ–‡ä»¶');

            const formData = new FormData();
            formData.append('file', file);

            const responseDiv = document.getElementById('uploadResponse');
            responseDiv.innerHTML = '<div class="response loading">æ­£åœ¨ä¸Šä¼ ...</div>';

            try {
                const response = await fetch(`${API_BASE}/documents/upload`, {
                    method: 'POST',
                    body: formData
                });
                const text = await response.text();
                responseDiv.innerHTML = `<div class="response">âœ… ${text}</div>`;
                fileInput.value = '';
            } catch (error) {
                responseDiv.innerHTML = `<div class="response error">é”™è¯¯: ${error.message}</div>`;
            }
        }

        async function ingestText() {
            const title = document.getElementById('textTitle').value;
            const text = document.getElementById('textContent').value;
            if (!title || !text) return alert('è¯·è¾“å…¥æ ‡é¢˜å’Œå†…å®¹');

            const responseDiv = document.getElementById('uploadResponse');
            responseDiv.innerHTML = '<div class="response loading">æ­£åœ¨å¤„ç†...</div>';

            try {
                const response = await fetch(`${API_BASE}/documents/ingest/text`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, text })
                });
                const result = await response.text();
                responseDiv.innerHTML = `<div class="response">âœ… ${result}</div>`;
                document.getElementById('textTitle').value = '';
                document.getElementById('textContent').value = '';
            } catch (error) {
                responseDiv.innerHTML = `<div class="response error">é”™è¯¯: ${error.message}</div>`;
            }
        }

        async function clearDocuments() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ–‡æ¡£å—ï¼Ÿ')) return;

            const responseDiv = document.getElementById('uploadResponse');
            responseDiv.innerHTML = '<div class="response loading">æ­£åœ¨æ¸…ç©º...</div>';

            try {
                await fetch(`${API_BASE}/documents/clear`, { method: 'DELETE' });
                responseDiv.innerHTML = '<div class="response">âœ… å·²æ¸…ç©ºæ‰€æœ‰æ–‡æ¡£</div>';
            } catch (error) {
                responseDiv.innerHTML = `<div class="response error">é”™è¯¯: ${error.message}</div>`;
            }
        }

        async function queryBasic() {
            const query = document.getElementById('queryBasic').value;
            if (!query) return alert('è¯·è¾“å…¥é—®é¢˜');

            const responseDiv = document.getElementById('queryBasicResponse');
            responseDiv.innerHTML = '<div class="response loading">æ­£åœ¨æŸ¥è¯¢...</div>';

            try {
                const response = await fetch(`${API_BASE}/rag/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                const result = await response.json();
                
                let html = `<div class="response">${result.response}</div>`;
                if (result.sources && result.sources.length > 0) {
                    html += '<div class="sources"><strong>æ¥æºï¼š</strong>';
                    result.sources.forEach(source => {
                        html += `<div class="source-item">ğŸ“„ ${source}</div>`;
                    });
                    html += '</div>';
                }
                responseDiv.innerHTML = html;
            } catch (error) {
                responseDiv.innerHTML = `<div class="response error">é”™è¯¯: ${error.message}</div>`;
            }
        }

        async function searchSimilar() {
            const query = document.getElementById('searchQuery').value;
            const topK = parseInt(document.getElementById('searchTopK').value);
            if (!query) return alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');

            const responseDiv = document.getElementById('searchResponse');
            responseDiv.innerHTML = '<div class="response loading">æ­£åœ¨æœç´¢...</div>';

            try {
                const response = await fetch(`${API_BASE}/rag/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, topK })
                });
                const results = await response.json();
                
                let html = '<div class="response"><strong>æœç´¢ç»“æœï¼š</strong><br><br>';
                results.forEach((doc, index) => {
                    html += `<div class="source-item">
                        <strong>${index + 1}. ${doc.metadata?.source || 'æœªçŸ¥æ¥æº'}</strong><br>
                        ${doc.content.substring(0, 200)}...
                    </div>`;
                });
                html += '</div>';
                responseDiv.innerHTML = html;
            } catch (error) {
                responseDiv.innerHTML = `<div class="response error">é”™è¯¯: ${error.message}</div>`;
            }
        }

        async function queryCitation() {
            const query = document.getElementById('queryCitation').value;
            if (!query) return alert('è¯·è¾“å…¥é—®é¢˜');

            const responseDiv = document.getElementById('queryCitationResponse');
            responseDiv.innerHTML = '<div class="response loading">æ­£åœ¨æŸ¥è¯¢...</div>';

            try {
                const response = await fetch(`${API_BASE}/rag/query/with-citations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                const result = await response.json();
                
                let html = `<div class="response">${result.response}</div>`;
                if (result.citations && result.citations.length > 0) {
                    html += '<div class="sources"><strong>å¼•ç”¨æ¥æºï¼š</strong>';
                    result.citations.forEach((citation, index) => {
                        html += `<div class="source-item">
                            [${index + 1}] ${citation.source}<br>
                            <small>${citation.content_preview}</small>
                        </div>`;
                    });
                    html += '</div>';
                }
                responseDiv.innerHTML = html;
            } catch (error) {
                responseDiv.innerHTML = `<div class="response error">é”™è¯¯: ${error.message}</div>`;
            }
        }

        async function queryMultiStep() {
            const query = document.getElementById('queryMultiStep').value;
            if (!query) return alert('è¯·è¾“å…¥é—®é¢˜');

            const responseDiv = document.getElementById('queryMultiStepResponse');
            responseDiv.innerHTML = '<div class="response loading">æ­£åœ¨æ·±åº¦åˆ†æï¼ˆå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼‰...</div>';

            try {
                const response = await fetch(`${API_BASE}/rag/query/multi-step`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                const text = await response.text();
                responseDiv.innerHTML = `<div class="response">${text}</div>`;
            } catch (error) {
                responseDiv.innerHTML = `<div class="response error">é”™è¯¯: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
